{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&family=Inter:wght@100..900&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&family=Tajawal:wght@200;300;400;500;700;800;900&family=Work+Sans:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <link rel="canonical" href="https://getbootstrap.com/docs/4.6/examples/carousel/">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">

    <link rel="shortcut icon" type="image/x-icon" href="{% static 'images/favicon/favicon.ico' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/favicon/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'images/favicon/site.webmanifest' %}">

    <title>الامتحان</title>

</head>d>
<body>

<div class="exam-time-left">
    <p id="countdown" class="float-left bg-danger text-light text-center px-2 fixed-top">الوقت المتبقي: <span class="">60</span> دقيقة</p>
</div>
<br>
<section class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-9 text-md-start">
                <div class="row align-items-center">
                    <div class="col-md-9">
                        <h2>امتحان مادة {{ subject }}</h2>
                        <h5>الدرجة الكبرى: {{ exam_token.exam.total_marks }}</h5>
                        <p class="mb-4">مدة الامتحان: <span class="">{{ exam_token.exam.duration_minutes }}</span> دقيقة</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <img src="{% static 'images/logo.png' %}" alt="شعار" style="max-width: 100px; height: auto;">
            </div>
            <div class="col-md-3 text-center">
                <h6>كلية {{ faculty }}</h6>
                <h6>{{ study_year }}</h6>
            </div>
        </div>
    </div>
</section>

<hr>

<section class="section">
    <div class="container">
        <form id="confirmForm" method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <div class="answer-center d-flex justify-content-center mt-4">
                <button type="button" id="confirmButton" class="btn btn-primary px-4 py-2">تأكيد الأجوبة</button>
            </div>
        </form>
    </div>
</section>

       <input type="hidden" id="time-remaining" value="{{ time_remaining_minutes|floatformat:'0' }}">

<br>
</body>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmButton = document.getElementById('confirmButton');
    const confirmForm = document.getElementById('confirmForm');

    function preventBack() {
        window.history.replaceState(null, "", window.location.href);
    }

    confirmButton.addEventListener('click', function() {
        const unansweredQuestions = checkUnansweredQuestions();
        if (unansweredQuestions.length > 0) {
            const confirmMessage = "لديك أسئلة لم تُجِب عليها. هل أنت متأكد أنك تريد تأكيد إجاباتك؟";
            const isConfirmed = confirm(confirmMessage);
            if (isConfirmed) {
                preventBack();
                confirmForm.submit();
                sessionStorage.clear();
            }
        } else {
            const isConfirmed = confirm("هل أنت متأكد أنك تريد إرسال إجاباتك؟");
            if (isConfirmed) {
                preventBack();
                confirmForm.submit();
                sessionStorage.clear();
            }
        }
    });

    function checkUnansweredQuestions() {
    const form = document.getElementById('confirmForm');
    const inputs = form.querySelectorAll('input[type="radio"]');
    const answeredQuestions = new Set();
    inputs.forEach(input => {
        if (input.checked) {
            const questionId = input.name.split('_')[1];
            answeredQuestions.add(questionId);
        }
    });
    const allQuestions = form.querySelectorAll('input[type="radio"]');
    const allQuestionIds = Array.from(allQuestions).map(input => input.name.split('_')[1]);
    const unansweredQuestions = allQuestionIds.filter(questionId => !answeredQuestions.has(questionId));
    return unansweredQuestions;
}


    var timeRemainingMinutes = parseInt(document.getElementById("time-remaining").value);
    var totalSeconds = sessionStorage.getItem('totalSeconds');
    if (!totalSeconds) {
        timeRemainingMinutes = parseInt(document.getElementById("time-remaining").value);
        totalSeconds = Math.floor(timeRemainingMinutes * 60);
    }

    function updateCountdown() {
        if (!isNaN(totalSeconds) && totalSeconds > 0) {
            var hours = Math.floor(totalSeconds / 3600);
            var minutes = Math.floor((totalSeconds % 3600) / 60);
            var seconds = totalSeconds % 60;
            totalSeconds = hours * 3600 + minutes * 60 + seconds;
            sessionStorage.setItem('totalSeconds', totalSeconds);

            hours = (hours < 10) ? "0" + hours : hours;
            minutes = (minutes < 10) ? "0" + minutes : minutes;
            seconds = (seconds < 10) ? "0" + seconds : seconds;

            document.getElementById("countdown").innerHTML = "الوقت المتبقي: " + hours + ":" + minutes + ":" + seconds;

            totalSeconds--;
            setTimeout(updateCountdown, 1000);
        } else {
            document.getElementById("countdown").innerHTML = "انتهى الوقت!";
            preventBack();
            document.getElementById('confirmForm').submit();
            sessionStorage.clear();
        }
    }

    updateCountdown();
});

</script>
</html>